<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TrAidz</title>
  <style>
    :root {
      --primary: #007bff;
      --primary-dark: #0056b3;
      --success: #28a745;
      --success-dark: #218838;
      --bg: #f8f9fa;
      --fg: #212529;
      --input-bg: #fff;
      --input-fg: #212529;
      --shadow: rgba(0, 0, 0, 0.1) 0px 4px 8px;
      --border-radius: 6px;
      --transition: 0.3s ease;
    }
    html[data-theme="dark"] {
      --bg: #121212;
      --fg: #f1f1f1;
      --input-bg: #1e1e1e;
      --input-fg: #f8f8f8;
      --shadow: rgba(255, 255, 255, 0.05) 0px 4px 12px;
    }
    *, *::before, *::after {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Roboto, sans-serif;
      font-size: 16px;
      line-height: 1.5;
      background: var(--bg);
      color: var(--fg);
      transition: background var(--transition), color var(--transition);
    }
    header {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      background: var(--primary);
      color: #fff;
      padding: 12px 20px;
      box-shadow: var(--shadow);
    }
    header img {
      height: 32px;
      margin-right: 12px;
    }
    header h1 {
      font-size: 20px;
      margin: 0;
      flex: 1;
    }
    .theme-toggle {
      font-size: 16px;
      padding: 6px 10px;
      background: var(--input-bg);
      color: var(--primary);
      border: none;
      border-radius: var(--border-radius);
      cursor: pointer;
      transition: background var(--transition);
      width: auto;
    }
    .theme-toggle:hover {
      opacity: 0.85;
    }
    main {
      padding: 20px;
      max-width: 900px;
      margin: auto;
    }
    .switch {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }
    .switch label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 16px;
      font-weight: 500;
    }
    #import {
      font-size: 16px;
    }
    .trade-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 12px;
      background: var(--bg);
      padding: 8px;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
    }
    .trade-row input,
    .trade-row button {
      font-size: 16px;
    }
    .trade-row input {
      flex: 1 1 150px;
      padding: 10px;
      border: 1px solid #555;
      background: var(--input-bg);
      color: var(--input-fg);
      border-radius: var(--border-radius);
      transition: border-color var(--transition);
    }
    .trade-row input:focus {
      border-color: var(--primary);
      outline: none;
    }
    .trade-row button {
      padding: 10px 14px;
      background: var(--primary);
      color: #fff;
      border: none;
      border-radius: var(--border-radius);
      cursor: pointer;
      transition: background var(--transition);
    }
    .trade-row button:hover {
      background: var(--primary-dark);
    }
    button {
      font-family: inherit;
    }
    .export-button {
      margin-top: 20px;
      padding: 10px 16px;
      font-size: 16px;
      background: var(--success);
      color: #fff;
      border: none;
      border-radius: var(--border-radius);
      cursor: pointer;
      transition: background var(--transition);
      width: auto;
    }
    .export-button:hover {
      background: var(--success-dark);
    }
    .results {
      margin-top: 25px;
    }
    .result-card {
      background: var(--input-bg);
      color: var(--input-fg);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      padding: 15px 20px;
      margin-bottom: 20px;
      transition: all var(--transition);
    }
    .result-card h3 {
      margin-top: 0;
      font-size: 18px;
      color: var(--primary);
    }
    .result-card p {
      margin: 4px 0;
    }
    .result-grand {
      background: var(--primary);
      color: white;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      padding: 18px 22px;
      font-weight: 500;
    }
    .result-grand h3 {
      margin: 0 0 8px 0;
    }
    @media (max-width: 600px) {
      header {
        flex-direction: column;
        align-items: flex-start;
      }
      header h1 {
        margin-top: 10px;
        font-size:42px;
      }
      .switch label,
      .export-button,
      .theme-toggle,
      .trade-row input,
      .trade-row button {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <header>
    <img src="logo.png" alt="Logo" />
    <h1>TrAidz</h1>
    <button id="theme-toggle" class="theme-toggle">Dark Mode</button>
  </header>
  <main>
    <div class="switch">
      <label><input type="radio" name="mode" value="average" checked> Average Cost</label>
      <label><input type="radio" name="mode" value="profit"> Profit</label>
      <input type="file" id="import" accept=".txt,.csv">
    </div>
    <div id="trade-list">
      <div class="trade-row">
        <input type="text" placeholder="Asset Name">
        <input type="number" placeholder="Quantity" step="any">
        <input type="number" placeholder="Cost Per Asset ($)" step="any">
        <button onclick="removeRow(this)">Remove</button>
      </div>
    </div>
    <button onclick="addRow()" style="margin-top:12px;font-size:16px;">Add Trade</button>
    <div class="results"></div>
    <button class="export-button" onclick="exportData()">Export to Text</button>
    <button class="export-button" onclick="exportToExcel()">Export to Excel</button>
  </main>


  <script>
    let mode = "average";

    // Dark/Light toggle
    const themeToggle = document.getElementById('theme-toggle');
    const saved = localStorage.getItem('theme') || 'light';
    document.documentElement.setAttribute('data-theme', saved);
    themeToggle.textContent = saved === 'light' ? 'Dark Mode' : 'Light Mode';

    themeToggle.onclick = () => {
      const t = document.documentElement.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
      document.documentElement.setAttribute('data-theme', t);
      localStorage.setItem('theme', t);
      themeToggle.textContent = t === 'dark' ? 'Light Mode' : 'Dark Mode';
    };

    // Import handling
    document.getElementById('import').addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;

      const fr = new FileReader();
      fr.onload = ev => {
        const txt = ev.target.result.trim(), isCsv = file.name.toLowerCase().endsWith('.csv');
        const lines = txt.split(/\r?\n/).filter(l => l.trim() && !l.toLowerCase().startsWith('grand total'));
        if (lines.length < 2) return;

        const headers = isCsv ? lines.shift().split(/\s*,\s*/) : lines.shift().trim().split(/\s{2,}/);
        const profitCol = headers.some(h => /profit|percent/i.test(h));

        document.querySelector(`input[value="${profitCol ? 'profit' : 'average'}"]`).checked = true;
        mode = profitCol ? 'profit' : 'average';
        updateFields();

        const tl = document.getElementById('trade-list');
        tl.innerHTML = '';
        lines.forEach(line => {
          const parts = isCsv ? line.split(/\s*,\s*/) : line.trim().split(/\s{2,}/);
          const [asset, qty, cost, sell] = parts;
          if (!asset) return;

          const div = document.createElement('div');
          div.className = 'trade-row';
          div.innerHTML = `
            <input type="text" placeholder="Asset Name" value="${asset}" />
            <input type="number" placeholder="Quantity" step="any" value="${parseFloat(qty)||''}" />
            <input type="number" placeholder="Cost Per Asset ($)" step="any" value="${parseFloat(cost.replace('$',''))||''}" />
            ${profitCol && sell ? `<input type="number" placeholder="Selling Price ($)" step="any" value="${parseFloat(sell.replace('$',''))||''}" />` : ''}
            <button onclick="removeRow(this)">Remove</button>
          `;
          tl.appendChild(div);
        });
        calculate();
      };
      fr.readAsText(file);
      e.target.value = '';
    });

    document.querySelectorAll('input[name="mode"]').forEach(el =>
      el.addEventListener('change', () => {
        mode = el.value;
        updateFields();
        calculate();
      })
    );

    function addRow() {
      const div = document.createElement('div');
      div.className = 'trade-row';
      div.innerHTML = `
        <input type="text" placeholder="Asset Name">
        <input type="number" placeholder="Quantity" step="any">
        <input type="number" placeholder="Cost Per Asset ($)" step="any">
        ${mode==='profit'?'<input type="number" placeholder="Selling Price ($)" step="any">':''}
        <button onclick="removeRow(this)">Remove</button>
      `;
      document.getElementById('trade-list').appendChild(div);
    }

    function removeRow(btn) {
      btn.parentElement.remove();
      calculate();
    }

    function updateFields() {
      document.querySelectorAll('.trade-row').forEach(row => {
        const sp = row.querySelector('input[placeholder="Selling Price ($)"]');
        if (mode === 'profit' && !sp) {
          const i = document.createElement('input');
          i.placeholder = 'Selling Price ($)';
          i.type = 'number';
          i.step = 'any';
          row.insertBefore(i, row.lastElementChild);
        } else if (mode === 'average' && sp) {
          sp.remove();
        }
      });
    }

    function calculate() {
      const rows = document.querySelectorAll('.trade-row');
      const assets = {};
      let grandQty=0, grandCost=0, grandRev=0, lastAsset='', spMap={};

      rows.forEach(r => {
        let a = r.children[0].value.trim();
        const qty = parseFloat(r.children[1].value)||0;
        const c = parseFloat(r.children[2].value)||0;
        let sp = mode==='profit'?parseFloat(r.children[3]?.value)||0:0;

        if (!a && lastAsset) {
          a = lastAsset;
          r.children[0].placeholder=lastAsset;
        } else if (a) lastAsset=a;

        if (mode==='profit') {
          if (sp) spMap[a]=sp;
          else if (spMap[a]) sp=spMap[a];
        }

        if (!assets[a]) assets[a]={ qty:0, cost:0, rev:0 };
        assets[a].qty += qty;
        assets[a].cost += qty*c;
        if (mode==='profit') assets[a].rev += qty*sp;

        grandQty+=qty;
        grandCost+=qty*c;
        if (mode==='profit') grandRev+=qty*sp;
      });

 const out = document.querySelector('.results');
out.innerHTML = '';

for (let [a, { qty, cost, rev }] of Object.entries(assets)) {
  const avg = cost / qty || 0,
        prof = rev - cost,
        pct = prof / cost * 100 || 0,
        val = mode === 'profit' ? rev : cost;

  out.innerHTML += `
    <div class="result-card">
      <h3>${a}</h3>
      <p>Quantity: ${qty.toFixed(6)}</p>
      <p>Value: $${val.toFixed(2)}</p>
      <p>Average Price: $${avg.toFixed(4)}</p>
      <p>Total Cost: $${cost.toFixed(2)}</p>
      ${mode === 'profit' ? `
        <p>Profit: $${prof.toFixed(2)}</p>
        <p>Percent Gain: ${pct.toFixed(2)}%</p>
      ` : ''}
    </div>
  `;
}

const gp = grandRev - grandCost,
      gpct = gp / grandCost * 100 || 0;

out.innerHTML += `
  <div class="result-grand">
    <h3>Grand Total</h3>
    <p>Total Quantity: ${grandQty.toFixed(6)}</p>
    <p>Total Cost: $${grandCost.toFixed(2)}</p>
    ${mode === 'profit' ? `
      <p>Profit: $${gp.toFixed(2)}</p>
      <p>Percent Gain: ${gpct.toFixed(2)}%</p>
    ` : ''}
  </div>
`;


      return { assets, grandQty, grandCost, grandRev, prof:gp, pct:gpct };
    }

function exportData() {
  const { assets, grandQty, grandCost, grandRev, prof, pct } = calculate();

  const pad = (str, len) => str.toString().padEnd(len, ' ');
  const rows = [];

  const headers = [
    pad("Asset Name", 14),
    pad("Quantity", 12),
    pad("Cost Per Asset", 20)
  ];

  if (mode === "profit") {
    headers.push(
      pad("Selling Price", 20),
      pad("Profit", 15),
      pad("Percent Gain", 15)
    );
  }

  rows.push(headers.join("  "));

  for (const [asset, data] of Object.entries(assets)) {
    const avg = (data.cost / data.qty).toFixed(4);
    const rev = (data.rev / data.qty).toFixed(4);
    const profit = (data.rev - data.cost).toFixed(2);
    const gain = ((data.rev - data.cost) / data.cost * 100).toFixed(2);

    const row = [
      pad(asset, 14),
      pad(data.qty.toFixed(6), 12),
      pad(`$${avg}`, 20)
    ];

    if (mode === "profit") {
      row.push(
        pad(`$${rev}`, 20),
        pad(`$${profit}`, 15),
        pad(`${gain}%`, 15)
      );
    }

    rows.push(row.join("  "));
  }

  // Grand total
  rows.push(""); // Empty line
  const grandRow = [
    pad("Grand Total", 14),
    pad(grandQty.toFixed(6), 12),
    pad(`$${(grandCost / grandQty).toFixed(4)}`, 20)
  ];

  if (mode === "profit") {
    grandRow.push(
      pad(`$${(grandRev / grandQty).toFixed(4)}`, 20),
      pad(`$${prof.toFixed(2)}`, 15),
      pad(`${pct.toFixed(2)}%`, 15)
    );
  }

  rows.push(grandRow.join("  "));

  const text = rows.join("\n");
  const blob = new Blob([text], { type: "text/plain" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "trades.txt";
  link.click();
}

function exportToExcel() {
  const { assets, grandQty, grandCost, grandRev, prof, pct } = calculate();
  const rows = [];

  const headers = ["Asset Name", "Quantity", "Cost Per Asset"];
  if (mode === "profit") {
    headers.push("Selling Price", "Profit", "Percent Gain");
  }
  rows.push(headers);

  for (const [asset, data] of Object.entries(assets)) {
    const avg = (data.cost / data.qty).toFixed(4);
    const rev = (data.rev / data.qty).toFixed(4);
    const profit = (data.rev - data.cost).toFixed(2);
    const gain = ((data.rev - data.cost) / data.cost * 100).toFixed(2);

    const row = [asset, data.qty.toFixed(6), `$${avg}`];
    if (mode === "profit") {
      row.push(`$${rev}`, `$${profit}`, `${gain}%`);
    }
    rows.push(row);
  }

  rows.push([]); // empty line before total
  const grandRow = [
    "Grand Total",
    grandQty.toFixed(6),
    `$${(grandCost / grandQty).toFixed(4)}`
  ];

  if (mode === "profit") {
    grandRow.push(
      `$${(grandRev / grandQty).toFixed(4)}`,
      `$${prof.toFixed(2)}`,
      `${pct.toFixed(2)}%`
    );
  }

  rows.push(grandRow);

  const csv = rows.map(r => r.join(",")).join("\n");
  const blob = new Blob([csv], { type: "text/csv" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "trades.csv";
  link.click();
}

    document.getElementById('trade-list').addEventListener('input', calculate);
  </script>
</body>
</html>
